<% include loginNav.ejs %>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<div style="width: 1174px;margin: 15px auto;">
    <img style="width:75px;height: 50px;" src="/images/logo.png" alt=""><span
            style="position: relative;top:-15px;left:20px;font-size: 17px;color: #666;">订单提交信息</span>
</div>

<div style="width: 1174px;height: 30px;line-height: 30px;margin: 5px auto;">
    <span style="font-size: 15px;float: left;color: #666;">商品和优惠卷、积分</span>
    <a href="/gouwuche"
       style="text-decoration: none;display: inline-block;border: 1px red solid;width: 80px;height: 15px;padding:10px 10px;color:red;text-align: center;float:right;line-height: 20px;">返回购物车</a>
</div>
<div style="width: 1174px;height: 1px;background:#ccc;margin: 20px auto;"></div>

<!--    商品信息-->
<% for(var i = 0;i < tt.length;i++){ %>
    <div style="width: 1174px;height: 100px;margin: 10px auto;border-bottom: 1px solid #eee">
        <img style="width:100px;height: 100px;float: left" src="<%= tt[i].img %>"
             alt="">
        <span style="width: 600px;height: 100px;text-align: center;line-height: 100px;float: left;display: inline-block;font-size: 16px;color: #666;"><%= tt[i].miaoshu %></span>
        <span style="width: 170px;height: 100px;text-align: center;line-height: 100px;float: left;display: inline-block;font-size: 17px;color: #666;"><%= tt[i].danjia %> x <%= tt[i].shuliang %></span>
        <span style="width: 100px;height: 100px;text-align: center;line-height: 100px;float: left;display: inline-block;font-size: 16px;color: #666;">有货</span>
        <span style="width: 150px;height: 100px;text-align: center;line-height: 100px;float: right;display: inline-block;font-size: 17px;color: red;"><%= xiaoji[i] %>元</span>
    </div>
<% } %>

<div style="width: 1174px;margin: 20px auto;">
    <img style="width:100%" src="/images/youhui.png" alt="">
</div>

<!--使用积分-->
<div style="width: 1174px;height:30px;margin: 15px auto;height: 50px;border-bottom: 1px solid #eee;">
    <span style="font-size: 16px;display: inline-block;width: 150px;height: 30px;float: left;line-height: 30px;color: #666;">使用积分</span>
    <input id="jifen" type="text" style="width: 200px;height: 28px;float: left;margin-left: 50px;">
    <span style="display: inline-block;width: 350px;height: 30px;float: left;font-size: 13px;line-height: 30px;color: #555;margin-left: 15px;">
            你有<span id="jifenmax" style="color: red;"><%= jieguo.jifen %></span>积分，
            你最多可以使用 <span style="color: red"><%= jieguo.jifen %></span>积分
        </span>
    <span style="font-size: 20px;display: inline-block;width: 100px;height: 30px;float:right;line-height: 30px;color: red;">
            -<span id="jifenyouhui">0</span>元
        </span>
</div>

<!--收货信息-->
<div style="width: 1174px;height: 30px;margin: auto;margin-top: 50px;font-size: 17px;">收货信息</div>
<div style="width: 1174px;height: 1px;margin: 0 auto;background: #eee;"></div>
<div style="width: 1174px;margin: 15px auto;">
    <span style="color: red">*</span>姓名： <input id="xingming" type="text" style="width: 200px;height: 30px;">
    <span style="color: red;margin-left: 200px;">*</span>手机号码： <input id="tel" type="text"
                                                                      style="width: 200px;height: 30px;">
    <br><br>
    <span style="color: red">*</span> 省份：<select id="Select1" style="width: 200px;height: 30px;"></select>
    市：<select id="Select2" style="width: 200px;height: 30px;"></select>
    地区：<select id="Select3" style="width: 200px;height: 30px;"></select> <textarea style="position: relative;top:5px;"
                                                                                   name="" id="jiedao" cols="50"
                                                                                   rows="3"
                                                                                   placeholder="区、街道编号/楼名称"></textarea>
    <br><br>
</div>

<div style="width: 1174px;height: 1px;margin: 0 auto;background: #eee;"></div>

<!--bottom-->
<div style="width: 1174px;margin: 20px auto;">
    <div style="width: 300px;height:250px;">
        <div style="width: 100%;height: 30px;">
            <span style="width: 40%;height: 100%;float: left;display: inline-block">商品件数：</span>
            <span style="width: 30%;height: 100%;float: right;display: inline-block;color: red;font-size: 20px;text-align: right">
                    <span><%= aaa[0] %></span>件
                </span>
        </div>
        <div style="width: 100%;height: 30px;">
            <span style="width: 40%;height: 100%;float: left;display: inline-block">金额合计：</span>
            <span style="width: 30%;height: 100%;float: right;display: inline-block;color: red;font-size: 20px;text-align: right">
                    <span id="yuanjia"><%= aaa[1] %></span>元
                </span>
        </div>
        <div style="width: 100%;height: 30px;">
            <span style="width: 40%;height: 100%;float: left;display: inline-block">优惠卷抵扣：</span>
            <span style="width: 30%;height: 100%;float: right;display: inline-block;color: red;font-size: 20px;text-align: right">
                    <span>0</span>元
                </span>
        </div>
        <div style="width: 100%;height: 30px;">
            <span style="width: 40%;height: 100%;float: left;display: inline-block">积分抵扣：</span>
            <span style="width: 30%;height: 100%;float: right;display: inline-block;color: red;font-size: 20px;text-align: right">
                    -<span id="jifendikou">0</span>元
                </span>
        </div>
        <div style="width: 100%;height: 30px;">
            <span style="width: 40%;height: 100%;float: left;display: inline-block">运费：</span>
            <span style="width: 30%;height: 100%;float: right;display: inline-block;color: red;font-size: 20px;text-align: right">
                    <span>0</span>元
                </span>
        </div>
        <br><br>
        <div style="width: 100%;height: 30px;">
            <span style="width: 40%;height: 100%;float: left;display: inline-block;color:red;">应付总额：</span>
            <span style="width: 50%;height: 100%;float: right;display: inline-block;color: red;font-size: 27px;text-align: right">
                    <span id="shifujine"><%= aaa[1] %></span>.00元
                </span>
        </div>
    </div>
</div>

<div style="width: 1174px;height: 80px;margin: 20px auto;">
    <button id="fukuan" class="<%= thing%>"
            style="width:200px;height: 50px;background: red;color: white;float: right;text-align: center;font-size: 17px;line-height: 50px;border: none;">
        提交订单
    </button>
</div>

<script src="/javascripts/jquery.js"></script>
<script src="/javascripts/layer.js"></script>
<script src="/javascripts/jsAddress.js"></script>
<script>
    addressInit('Select1', 'Select2', 'Select3');
    var jifen = document.getElementById('jifen')
    var jifenyouhui = document.getElementById('jifenyouhui')
    var jifenmax = document.getElementById('jifenmax')
    var jifendikou = document.getElementById('jifendikou')
    var fukuan = document.getElementById('fukuan')
    var shifujine = document.getElementById('shifujine')
    var yuanzongjia = shifujine.innerText
    jifen.onkeyup = function () {
        var regex = /^\d+$/;
        var n = jifen.value
        if (regex.test(n)) {
            if (jifen.value <= Number(jifenmax.innerHTML) && n >= 0) {
                shifujine.innerText = yuanzongjia
                jifenyouhui.innerHTML = jifen.value
                jifendikou.innerHTML = jifen.value
                shifujine.innerText = shifujine.innerText - jifen.value
            } else {
                // n=jifenmax.innerHTML
                shifujine.innerText = yuanzongjia
                jifen.value = Number(jifenmax.innerHTML)
                jifenyouhui.innerHTML = Number(jifenmax.innerHTML)
                jifendikou.innerText = Number(jifenmax.innerHTML)
                shifujine.innerText = shifujine.innerText - Number(jifenmax.innerHTML)

            }
        } else {
            jifen.value = ''
            jifenyouhui.innerHTML = 0
            jifendikou.innerHTML = 0
            shifujine.innerText = yuanzongjia
        }
    }

    function getNowFormatDate() {
        var date = new Date();
        var seperator1 = "-";
        var s = ':'
        var year = date.getFullYear();
        var month = date.getMonth() + 1;
        var strDate = date.getDate();
        var hh = date.getHours();            //时
        var mm = date.getMinutes();          //分
        var ss = date.getSeconds();
        if (month >= 1 && month <= 9) {
            month = "0" + month;
        }
        if (strDate >= 0 && strDate <= 9) {
            strDate = "0" + strDate;
        }
        var currentdate = year + seperator1 + month + seperator1 + strDate + ' ' + hh + s + mm + s + ss;
        return currentdate;
    }

    fukuan.onclick = function () {
        if(xingming.value == ''){
            alert('请输入收货人姓名')
            return
        }
        if(tel.value == ''){
            alert('请输入收货人电话')
            return
        }
        var isbeauty = confirm(`您确定要支付${shifujine.innerText}元购买吗`)
        if (isbeauty == true) {
            $.ajax('/Mydingdan', {
                method: 'GET',
                data: {
                    jifen: jifen.value,
                    xingming: xingming.value,
                    tel: tel.value,
                    sheng: Select1.value,
                    shi: Select2.value,
                    qu: Select3.value,
                    jiedao: jiedao.value,
                    yuanjia: yuanjia.innerHTML,
                    shifujine: shifujine.innerText,
                    shijian: getNowFormatDate(),
                    class:this.className
                },
                success: function (result) {
                    var index = layer.load(1, {
                        shade: [0.1, '#fff'] //0.1透明度的白色背景
                    });
                    setTimeout(function () {
                        layer.msg('付款成功,正在跳转')
                        setTimeout(() => {
                            location.href = '/Mydingdan'
                        }, 1500)
                    }, 1500)

                },
                error: function (err) {
                    console.log(err)
                }
            })
        }
    }
</script>
</body>
<% include base/nav-bot.ejs %>
</html>